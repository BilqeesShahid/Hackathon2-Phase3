# Implementation Plan: AI-Powered Todo Chatbot

**Branch**: `002-ai-chatbot` | **Date**: 2025-12-29 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-ai-chatbot/spec.md`

**Note**: This plan is generated by the `/sp.plan` command following Spec-Driven Development.

## Summary

**Primary Requirement**: Transform the Phase II web application into an AI-powered conversational chatbot that manages tasks through natural language, establishing a Reusable Intelligence Architecture with modular subagents and skills.

**Technical Approach**:
- Implement agent-driven architecture using OpenAI Agents SDK (Python)
- Create 4 specialized subagents for task reasoning, conversation memory, tool orchestration, and response formatting
- Develop 4 reusable agent skills for intent parsing, MCP invocation, error recovery, and conversation summarization
- Build MCP server with 5 tools (add_task, list_tasks, update_task, complete_task, delete_task) as the only system interface
- Maintain stateless backend with database-persisted conversations and messages
- Deploy OpenAI ChatKit frontend for conversational UI
- Ensure all intelligence components are reusable for future phases (IV: Kubernetes, V: Kafka)

## Technical Context

**Language/Version**: Python 3.13+
**Primary Dependencies**:
- Backend: FastAPI, SQLModel, OpenAI Agents SDK (Python), Official MCP SDK
- Frontend: OpenAI ChatKit, TypeScript, React
- Database: Neon Serverless PostgreSQL
- Authentication: Better Auth (JWT)

**Storage**: Neon Serverless PostgreSQL with SQLModel ORM
- Existing tables: users, tasks
- New tables: conversations, messages

**Testing**: pytest (backend), Jest/Vitest (frontend) - NEEDS CLARIFICATION on specific test strategy

**Target Platform**:
- Backend: Linux server / cloud platform (stateless, horizontally scalable)
- Frontend: Modern web browsers (Chrome, Firefox, Safari, Edge)

**Project Type**: Web (full-stack with conversational UI)

**Performance Goals**:
- Response time < 3 seconds for typical chat requests
- Support concurrent users with stateless architecture
- Efficient conversation history retrieval
- OpenAI API latency considerations - NEEDS CLARIFICATION on rate limits and optimization

**Constraints**:
- Stateless backend (zero in-memory state)
- MCP-only system interface (no direct database access by agents)
- JWT authentication required for all requests
- User isolation enforced at MCP tool and database levels
- Response time < 3 seconds p95

**Scale/Scope**:
- Multi-user system (exact scale TBD)
- 4 subagents + 4 skills (modular intelligence)
- 5 MCP tools
- 2 new database tables
- Single chat endpoint + conversation management
- Reusable for Phases IV & V

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### ✅ Spec-Driven Development (§2.1)
- Feature specification exists: `/specs/002-ai-chatbot/spec.md`
- No implementation started before spec approval
- Claude Code will generate all code
- Manual coding is prohibited

### ✅ Agent-First Design (§2.3)
- Business logic will live in AI agents, not controllers
- FastAPI serves as transport layer, auth verification, persistence gateway only
- All task management reasoning delegated to agents
- Direct database access by agents is forbidden

### ✅ MCP as Only System Interface (§2.4)
- Agents interact only through MCP tools
- SQLModel queries wrapped in MCP tools
- All state changes go through MCP
- 5 MCP tools defined: add_task, list_tasks, update_task, complete_task, delete_task

### ✅ Stateless Backend (§2.5)
- Zero in-memory state
- Conversation and task state persist in database
- System is restart-safe
- No session storage in memory

### ✅ Reusable Intelligence Mandate (§2.6)
- 4 subagents designed for modularity:
  - Task Reasoning (reusable for event-driven flows, automation)
  - Conversation Memory (reusable for long sessions, multi-agent orchestration)
  - Tool Orchestration (reusable for Kafka workflows, background jobs)
  - Response Formatting (reusable for voice, multilingual)
- 4 agent skills designed for composability:
  - Intent Parsing
  - MCP Tool Invocation
  - Error Recovery
  - Conversation Summarization
- All components designed for Phases IV & V

### ✅ Required Subagents (§5.2)
- All 4 required subagents will be implemented
- Each has clear responsibility boundary
- Each defines reusability scope

### ✅ Required Agent Skills (§5.3)
- All 4 required skills will be implemented
- Skills are generic and composable
- No hard-coded business logic

### ✅ Technology Mandates (§6)
- Frontend: OpenAI ChatKit ✓
- Backend: FastAPI ✓
- AI Framework: OpenAI Agents SDK (Python) ✓
- MCP Server: Official MCP SDK ✓
- Database: Neon Serverless PostgreSQL with SQLModel ✓
- Authentication: Better Auth (JWT) ✓

### ✅ Security & User Isolation (§7)
- JWT authentication required for all chat requests
- User identity extracted from JWT claims
- MCP tools validate user_id parameter
- Ownership enforced at MCP tool and database query levels
- No cross-user data leakage possible

### ✅ Chat API Design (§8)
- Endpoint: `POST /api/{user_id}/chat`
- Stateless request flow defined
- Request/response contracts specified
- All responses are JSON

### ✅ Data Integrity (§9)
- Task integrity rules preserved
- Conversation integrity rules defined
- All state in database tables (tasks, conversations, messages)
- No in-memory state

### ✅ Forbidden Patterns (§12)
- ❌ No monolithic agent
- ❌ No hard-coded reasoning in route handlers
- ❌ No tool calls embedded in FastAPI endpoints
- ❌ No direct database access by agents
- ❌ No in-memory conversation state
- ✅ Subagent architecture mandatory

### ✅ Behavioral Guarantees (§15)
- Natural language understanding
- MCP tool-based operations
- Polite confirmations
- Graceful ambiguity handling
- Reliable conversation resumption
- Clarifying questions when needed
- No hallucinated data
- Verification through MCP tools

**GATE STATUS**: ✅ **PASS** - All constitutional requirements satisfied

## Project Structure

### Documentation (this feature)

```text
specs/002-ai-chatbot/
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output - Research on OpenAI Agents SDK, MCP SDK, ChatKit
├── data-model.md        # Phase 1 output - Database schema for conversations/messages
├── quickstart.md        # Phase 1 output - Setup and development guide
├── contracts/           # Phase 1 output - MCP tool schemas, chat API contracts
└── tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── models/
│   │   ├── conversation.py    # NEW: Conversation model
│   │   ├── message.py         # NEW: Message model
│   │   └── task.py            # EXISTING
│   ├── agents/
│   │   ├── main_agent.py            # NEW: Main orchestrator agent
│   │   ├── subagents/
│   │   │   ├── task_reasoning.py    # NEW: Task reasoning subagent
│   │   │   ├── conversation_memory.py  # NEW: Conversation memory subagent
│   │   │   ├── tool_orchestration.py   # NEW: Tool orchestration subagent
│   │   │   └── response_formatting.py  # NEW: Response formatting subagent
│   │   └── skills/
│   │       ├── intent_parsing.py       # NEW: Intent parsing skill
│   │       ├── mcp_invocation.py       # NEW: MCP tool invocation skill
│   │       ├── error_recovery.py       # NEW: Error recovery skill
│   │       └── conversation_summarization.py  # NEW: Summarization skill
│   ├── mcp/
│   │   ├── server.py              # NEW: MCP server implementation
│   │   └── tools/
│   │       ├── add_task.py        # NEW: MCP tool
│   │       ├── list_tasks.py      # NEW: MCP tool
│   │       ├── update_task.py     # NEW: MCP tool
│   │       ├── complete_task.py   # NEW: MCP tool
│   │       └── delete_task.py     # NEW: MCP tool
│   ├── api/
│   │   ├── chat.py                # NEW: Chat endpoint
│   │   └── auth.py                # EXISTING: JWT middleware
│   └── lib/
│       └── database.py            # EXISTING: Database connection
└── tests/
    ├── agents/                    # NEW: Agent tests
    ├── mcp/                       # NEW: MCP tool tests
    ├── api/                       # NEW: Chat API tests
    └── integration/               # NEW: End-to-end tests

frontend/
├── src/
│   ├── components/
│   │   └── ChatInterface.tsx      # NEW: OpenAI ChatKit integration
│   ├── pages/
│   │   └── chat.tsx               # NEW: Chat page
│   ├── services/
│   │   └── chatApi.ts             # NEW: Chat API client
│   └── hooks/
│       └── useChat.ts             # NEW: Chat state management
└── tests/
    └── chat/                      # NEW: Chat UI tests

specs/
├── agents/                        # NEW: Agent specifications
│   ├── task-reasoning.md
│   ├── conversation-memory.md
│   ├── tool-orchestration.md
│   ├── response-formatting.md
│   └── skills/
│       ├── intent-parsing.md
│       ├── mcp-invocation.md
│       ├── error-recovery.md
│       └── conversation-summarization.md
└── api/
    └── mcp-tools.md               # NEW: MCP tools specification
```

**Structure Decision**: Web application (Option 2) with Phase III extensions for AI agents, MCP server, and conversational UI. The backend is extended with three new directories: `agents/` (for AI logic), `mcp/` (for system interface tools), and enhanced `api/` (for chat endpoint). The frontend adds ChatKit-based chat interface. All agent-related code is isolated in the `agents/` directory to maintain modularity and support future reuse in Phases IV & V.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**No constitutional violations detected.** All requirements align with Phase III Constitution.

---

## Phase 0: Research & Unknowns Resolution

### Research Tasks

Based on Technical Context "NEEDS CLARIFICATION" items:

1. **OpenAI Agents SDK (Python) Best Practices**
   - Unknown: How to structure subagents and skills properly
   - Unknown: OpenAI API rate limits and optimization strategies
   - Research focus: Official documentation, agent patterns, tool calling

2. **MCP SDK Integration**
   - Unknown: How to implement MCP server with FastAPI
   - Unknown: Tool schema definition and validation
   - Research focus: Official MCP SDK docs, Python examples

3. **OpenAI ChatKit Frontend**
   - Unknown: ChatKit setup and configuration
   - Unknown: JWT token management in ChatKit
   - Research focus: ChatKit documentation, authentication patterns

4. **Testing Strategy**
   - Unknown: How to test AI agents effectively
   - Unknown: Mocking OpenAI API calls in tests
   - Research focus: pytest strategies for agent testing, API mocking

### Research Output

Research findings will be documented in `research.md` with format:
- **Decision**: What was chosen
- **Rationale**: Why it was chosen
- **Alternatives Considered**: What else was evaluated
- **Implementation Notes**: Key technical details
